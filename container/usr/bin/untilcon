#!/bin/bash

if [ -z "$1" ]; then
  echo "ERROR: Missing target host/address!"
  exit 127
elif [ -z "$2" ]; then
  echo "ERROR: Missing target port!"
  exit 127
fi

if [ -n "$3" ]; then
  if [[ ! $3 =~ ^-?[0-9]+$ ]]; then
    echo "ERROR: Invalid max retries!"
    exit 127
  fi

  declare -r MAX_RETRIES="$3"
else
  declare -r MAX_RETRIES=60
fi

if [ -n "$4" ]; then
  if [[ ! $4 =~ ^-?[0-9]+$ ]]; then
    echo "ERROR: Invalid interval!"
    exit 127
  fi

  declare -r INTERVAL="$4"
else
  declare -r INTERVAL=3
fi

trap 'exit 2' ERR
declare RETRIES=0

until nc -z -v -w30 "$1" "$2"; do
  [[ "$RETRIES" -gt "$MAX_RETRIES" ]] && exit 1
  let 'RETRIES=RETRIES+1'
  sleep $INTERVAL
done

exit 0